name: Vector Integration Check

on:
  pull_request:
    branches: [ main ]

jobs:
  check-vector:
    if: github.actor == 'dependabot[bot]'
    runs-on: ubuntu-latest
    steps:
      - name: Checkout VRL (main branch)
        uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Clone Vector repo and update VRL dependency
        run: |
          git clone https://github.com/vectordotdev/vector.git
          cd vector
          git switch master
          VRL_BRANCH=$(cd ../vrl && git rev-parse --abbrev-ref HEAD)
          sed -i.bak "s|\(vrl = {[^}]*branch = \)\"[^\"]*\"|\1\"$VRL_BRANCH\"|" Cargo.toml
          cargo update -p vrl

      - name: Cargo Check Vector
        run: |
          cd vector
          cargo update -p vrl
          cargo check --workspace
